{"version":3,"file":"canvas.component.js","sourceRoot":"","sources":["../../../../../packages/core/src/lib/canvas.component.ts"],"names":[],"mappings":"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","sourcesContent":["import { DOCUMENT } from '@angular/common';\nimport {\n  ChangeDetectionStrategy,\n  Component,\n  ElementRef,\n  EventEmitter,\n  HostBinding,\n  Inject,\n  Input,\n  NgZone,\n  OnInit,\n  Output,\n  Self,\n  ViewChild,\n} from '@angular/core';\nimport { asapScheduler, fromEvent } from 'rxjs';\nimport { observeOn, takeUntil } from 'rxjs/operators';\nimport type { Scene, WebGLRenderer, WebGLShadowMap } from 'three';\nimport { DestroyedService, LoopService } from './services';\nimport {\n  AnimationStore,\n  CanvasStore,\n  EventsStore,\n  InstancesStore,\n} from './stores';\nimport type {\n  CameraOptions,\n  RaycasterOptions,\n  SceneOptions,\n  ThreeCameraAlias,\n} from './typings';\n\n@Component({\n  selector: 'ngt-canvas',\n  exportAs: 'ngtCanvas',\n  template: ` <canvas #rendererCanvas></canvas> `,\n  styles: [\n    `\n      :host {\n        display: block;\n        position: relative;\n        width: 100%;\n        height: 100%;\n        overflow: hidden;\n      }\n\n      :host canvas {\n        display: block;\n      }\n    `,\n  ],\n  changeDetection: ChangeDetectionStrategy.OnPush,\n  providers: [\n    CanvasStore,\n    EventsStore,\n    InstancesStore,\n    AnimationStore,\n    LoopService,\n    DestroyedService,\n  ],\n})\nexport class CanvasComponent implements OnInit {\n  @HostBinding('class.ngt-canvas') hostClass = true;\n\n  @Input() set orthographic(v: boolean) {\n    this.canvasStore.setIsOrthographic(v);\n  }\n\n  @Input() set linear(v: boolean) {\n    this.canvasStore.setIsLinear(v);\n  }\n\n  @Input() set shadows(v: boolean | Partial<WebGLShadowMap>) {\n    this.canvasStore.setShadows(v);\n  }\n\n  @Input() camera?: CameraOptions;\n  @Input() scene?: SceneOptions;\n  @Input() raycaster?: RaycasterOptions = {};\n\n  @Output() created = new EventEmitter<{\n    gl: WebGLRenderer;\n    camera: ThreeCameraAlias;\n    scene: Scene;\n  }>();\n\n  @ViewChild('rendererCanvas', { static: true })\n  rendererCanvas!: ElementRef<HTMLCanvasElement>;\n\n  constructor(\n    @Self() private readonly canvasStore: CanvasStore,\n    @Self() private readonly animationStore: AnimationStore,\n    @Self() private readonly eventsStore: EventsStore,\n    @Self() private readonly loopService: LoopService,\n    private readonly ngZone: NgZone,\n    private readonly hostElement: ElementRef<HTMLElement>,\n    @Inject(DOCUMENT) private readonly document: Document,\n    private readonly destroyed: DestroyedService\n  ) {}\n\n  ngOnInit(): void {\n    this.ngZone.runOutsideAngular(() => {\n      this.canvasStore.setSize({\n        width: this.hostElement.nativeElement.clientWidth,\n        height: this.hostElement.nativeElement.clientHeight,\n      });\n\n      this.canvasStore.setDpr(\n        (this.document as Document).defaultView?.devicePixelRatio || 1\n      );\n\n      this.canvasStore.initRendererEffect(this.rendererCanvas.nativeElement);\n      this.canvasStore.initSceneEffect(this.scene);\n      this.canvasStore.initCameraEffect(this.camera);\n      this.canvasStore.initRaycasterEffect(this.raycaster);\n\n      this.initWindowResizeListener();\n      this.initActiveListener();\n    });\n  }\n\n  private initWindowResizeListener() {\n    if (this.document?.defaultView) {\n      fromEvent(this.document.defaultView, 'resize')\n        .pipe(takeUntil(this.destroyed))\n        .subscribe(() => {\n          this.ngZone.runOutsideAngular(() => {\n            this.canvasStore.windowResizeEffect({\n              size: {\n                width: this.hostElement.nativeElement.clientWidth,\n                height: this.hostElement.nativeElement.clientHeight,\n              },\n              dpr:\n                (this.document as Document).defaultView?.devicePixelRatio || 1,\n            });\n          });\n        });\n    }\n  }\n\n  private initActiveListener() {\n    this.canvasStore.active$\n      .pipe(takeUntil(this.destroyed), observeOn(asapScheduler))\n      .subscribe((active) => {\n        this.ngZone.runOutsideAngular(() => {\n          if (active) {\n            const { renderer, camera, scene } =\n              this.canvasStore.getImperativeState();\n            if (renderer && camera && scene) {\n              this.created.emit({ gl: renderer, camera, scene });\n              this.eventsStore.connectEffect(renderer.domElement);\n              this.loopService.start();\n            }\n          }\n        });\n      });\n  }\n}\n"]}