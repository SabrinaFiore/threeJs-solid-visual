{"version":3,"file":"object-3d.abstract.js","sourceRoot":"","sources":["../../../../../../packages/core/src/lib/abstracts/object-3d.abstract.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  Directive,\n  Inject,\n  NgZone,\n  OnChanges,\n  OnDestroy,\n  Optional,\n  Output,\n  SkipSelf,\n} from '@angular/core';\nimport { BehaviorSubject, Observable, Subscription } from 'rxjs';\nimport { filter, take } from 'rxjs/operators';\nimport type { Object3D } from 'three';\nimport { Color } from 'three';\nimport { Object3dControllerDirective } from '../controllers';\nimport { OBJECT_3D_WATCHED_CONTROLLER } from '../di';\nimport {\n  AnimationStore,\n  CanvasStore,\n  EventsStore,\n  InstancesStore,\n} from '../stores';\nimport type {\n  EventHandlers,\n  InstanceInternal,\n  ThreeEvent,\n  ThreeInstance,\n  UnknownRecord,\n} from '../typings';\nimport { applyProps } from '../utils';\nimport { AnimationLoopParticipant } from './animation-loop-participant.abstract';\n\n@Directive()\nexport abstract class ThreeObject3d<TObject extends Object3D = Object3D>\n  extends AnimationLoopParticipant<TObject>\n  implements OnDestroy, OnChanges\n{\n  private $object3d = new BehaviorSubject<TObject | null>(null);\n\n  get object3d$(): Observable<TObject | null> {\n    return this.$object3d.asObservable();\n  }\n\n  @Output() ready = this.object3d$.pipe(filter(Boolean)) as Observable<TObject>;\n\n  private changesSubscription?: Subscription;\n\n  constructor(\n    @Inject(OBJECT_3D_WATCHED_CONTROLLER)\n    protected readonly object3dController: Object3dControllerDirective,\n    protected readonly canvasStore: CanvasStore,\n    protected readonly instancesStore: InstancesStore,\n    protected readonly eventsStore: EventsStore,\n    readonly animationStore: AnimationStore,\n    readonly ngZone: NgZone,\n    @Optional()\n    @SkipSelf()\n    protected readonly parentObjectDirective?: ThreeObject3d\n  ) {\n    super(animationStore, ngZone);\n\n    this.changesSubscription = object3dController.change$.subscribe(() => {\n      if (this.object3d) {\n        this.applyCustomProps();\n      }\n      if (this.inputChangeHandler) {\n        this.inputChangeHandler();\n      }\n    });\n  }\n\n  ngOnChanges() {\n    if (this.object3d) {\n      this.applyCustomProps();\n    }\n  }\n\n  protected init() {\n    this.ngZone.runOutsideAngular(() => {\n      this.initObject();\n\n      if (this.object3d) {\n        this.applyCustomProps();\n\n        applyProps(this.object3d, {\n          __ngt: {\n            canvasStateGetter: () => this.canvasStore.getImperativeState(),\n            eventsStateGetter: () => this.eventsStore.getImperativeState(),\n            handlers: this.applyEvents(),\n          } as InstanceInternal,\n        });\n\n        this.instancesStore.saveObject(\n          this.object3d as unknown as ThreeInstance\n        );\n\n        this.appendToParent();\n        this.objectReady();\n      }\n    });\n  }\n\n  protected addToScene() {\n    const { scene } = this.canvasStore.getImperativeState();\n    if (scene) {\n      scene.add(this.object3d);\n    }\n  }\n\n  protected addToParent() {\n    if (this.parentObjectDirective) {\n      this.parentObjectDirective.object3d.add(this.object3d);\n    } else {\n      this.addToScene();\n    }\n  }\n\n  protected remove() {\n    if (this.object3dController.appendTo) {\n      this.object3dController.appendTo.remove(this.object3d);\n    } else if (\n      this.parentObjectDirective &&\n      this.object3dController.appendMode === 'immediate'\n    ) {\n      this.parentObjectDirective.object3d.remove(this.object3d);\n    } else {\n      const { scene } = this.canvasStore.getImperativeState();\n      if (scene) {\n        scene.remove(this.object3d);\n      }\n    }\n\n    this.object3d.clear();\n  }\n\n  protected objectReady() {\n    this.$object3d.next(this.object3d);\n    this.participate(this.object3d);\n  }\n\n  protected inputChangeHandler?: () => void;\n\n  private applyCustomProps() {\n    this.ngZone.runOutsideAngular(() => {\n      const customProps = {\n        castShadow: this.object3dController.castShadow,\n        receiveShadow: this.object3dController.receiveShadow,\n        visible: this.object3dController.visible,\n        matrixAutoUpdate: this.object3dController.matrixAutoUpdate,\n      } as UnknownRecord;\n\n      if (this.object3dController.name) {\n        customProps['name'] = this.object3dController.name;\n      }\n\n      if (this.object3dController.position) {\n        customProps['position'] = this.object3dController.position;\n      }\n\n      if (this.object3dController.rotation) {\n        customProps['rotation'] = this.object3dController.rotation;\n      } else if (this.object3dController.quaternion) {\n        customProps['quaternion'] = this.object3dController.quaternion;\n      }\n\n      if (this.object3dController.scale) {\n        customProps['scale'] = this.object3dController.scale;\n      }\n\n      if (this.object3dController.userData) {\n        customProps['userData'] = this.object3dController.userData;\n      }\n\n      if (this.object3dController.color) {\n        this.object3dController.color = Array.isArray(\n          this.object3dController.color\n        )\n          ? new Color(...this.object3dController.color)\n          : new Color(this.object3dController.color);\n        if (!this.canvasStore.getImperativeState().isLinear) {\n          this.object3dController.color.convertSRGBToLinear();\n        }\n        customProps['color'] = this.object3dController.color;\n      }\n\n      if (this.object3dController.dispose) {\n        customProps['dispose'] = this.object3dController.dispose;\n      }\n\n      this.object3dController.change$.pipe(take(1)).subscribe((changes) => {\n        if (changes) {\n          for (const [inputName, inputChange] of Object.entries(changes)) {\n            if (\n              !inputChange.isFirstChange() ||\n              [\n                'name',\n                'position',\n                'rotation',\n                'quaternion',\n                'scale',\n                'userData',\n                'color',\n                'dispose',\n                'castShadow',\n                'receiveShadow',\n                'visible',\n                'matrixAutoUpdate',\n              ].includes(inputName) // skip 12 common inputs\n            ) {\n              continue;\n            }\n            customProps[inputName] = inputChange.currentValue;\n          }\n        }\n      });\n\n      applyProps(this.object3d, customProps);\n      this.object3d.updateMatrix();\n    });\n  }\n\n  private applyEvents(): EventHandlers {\n    const handlers: EventHandlers = {};\n\n    (\n      [\n        'click',\n        'contextmenu',\n        'dblclick',\n        'pointerup',\n        'pointerdown',\n        'pointerover',\n        'pointerout',\n        'pointerenter',\n        'pointerleave',\n        'pointermove',\n        'pointermissed',\n        'pointercancel',\n        'wheel',\n      ] as const\n    ).forEach((eventName) => {\n      if (this.object3dController[eventName].observed) {\n        handlers[eventName] = (\n          event: Parameters<\n            Exclude<EventHandlers[typeof eventName], undefined>\n          >[0]\n        ) => {\n          this.ngZone.run(() => {\n            this.object3dController[eventName].emit(event as ThreeEvent<any>);\n          });\n        };\n      }\n    });\n\n    return handlers;\n  }\n\n  private appendToParent(): void {\n    if (this.object3dController.appendTo) {\n      this.object3dController.appendTo.add(this.object3d);\n      return;\n    }\n\n    if (this.object3dController.appendMode === 'root') {\n      this.addToScene();\n      return;\n    }\n\n    if (this.object3dController.appendMode === 'immediate') {\n      this.addToParent();\n    }\n  }\n\n  ngOnDestroy(): void {\n    super.ngOnDestroy();\n    if (this.changesSubscription) {\n      this.changesSubscription.unsubscribe();\n    }\n    this.ngZone.runOutsideAngular(() => {\n      if (this.object3d) {\n        this.remove();\n        this.instancesStore.removeObject(this.object3d.uuid);\n        this.animationStore.unregisterAnimationEffect(this.object3d.uuid);\n      }\n    });\n  }\n\n  protected abstract initObject(): void;\n\n  abstract get object3d(): TObject;\n}\n"]}