{"version":3,"file":"primitive.directive.js","sourceRoot":"","sources":["../../../../../../packages/core/src/lib/primitive/primitive.directive.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  Directive,\n  EventEmitter,\n  Inject,\n  Input,\n  NgZone,\n  OnDestroy,\n  OnInit,\n  Optional,\n  Output,\n  SkipSelf,\n} from '@angular/core';\nimport { Object3D } from 'three';\nimport { AnimationLoopParticipant, ThreeObject3d } from '../abstracts';\nimport { Object3dControllerDirective } from '../controllers';\nimport {\n  OBJECT_3D_CONTROLLER_PROVIDER,\n  OBJECT_3D_WATCHED_CONTROLLER,\n} from '../di';\nimport { AnimationStore, CanvasStore } from '../stores';\n\n@Directive({\n  selector: 'ngt-primitive',\n  exportAs: 'ngtPrimitive',\n  providers: [\n    {\n      provide: ThreeObject3d,\n      useExisting: PrimitiveDirective,\n    },\n    OBJECT_3D_CONTROLLER_PROVIDER,\n  ],\n})\nexport class PrimitiveDirective<TObject = unknown>\n  extends AnimationLoopParticipant<TObject>\n  implements OnInit, OnDestroy\n{\n  @Output() ready = new EventEmitter<TObject>();\n\n  get object(): TObject {\n    return this._object;\n  }\n\n  @Input()\n  set object(value: TObject) {\n    if (value == null) {\n      console.error('[object] is required');\n    }\n    this._object = value;\n    if (value) {\n      this.ready.emit(value);\n      this.participate(value);\n    }\n  }\n\n  private _object!: TObject;\n\n  constructor(\n    readonly animationStore: AnimationStore,\n    readonly ngZone: NgZone,\n    @Inject(OBJECT_3D_WATCHED_CONTROLLER)\n    private readonly object3dController: Object3dControllerDirective,\n    private readonly canvasStore: CanvasStore,\n    @Optional()\n    @SkipSelf()\n    protected readonly parentObjectDirective?: ThreeObject3d\n  ) {\n    super(animationStore, ngZone);\n  }\n\n  get object3d(): TObject {\n    return this._object;\n  }\n\n  ngOnInit() {\n    this.ngZone.runOutsideAngular(() => {\n      this.appendToParent();\n    });\n  }\n\n  ngOnDestroy() {\n    super.ngOnDestroy();\n    this.ngZone.runOutsideAngular(() => {\n      if (this.object3d) {\n        this.remove();\n      }\n    });\n  }\n\n  private appendToParent() {\n    if (this.object3d && this.object3d instanceof Object3D) {\n      if (this.object3dController.appendTo) {\n        this.object3dController.appendTo.add(this.object3d);\n        return;\n      }\n\n      const { scene } = this.canvasStore.getImperativeState();\n      if (this.object3dController.appendMode === 'root') {\n        if (scene) {\n          scene.add(this.object3d);\n        }\n        return;\n      }\n\n      if (this.object3dController.appendMode === 'immediate') {\n        if (this.parentObjectDirective) {\n          this.parentObjectDirective.object3d.add(this.object3d);\n        } else {\n          if (scene) {\n            scene.add(this.object3d);\n          }\n        }\n      }\n    }\n  }\n\n  protected remove() {\n    if (this.object3d instanceof Object3D) {\n      if (this.object3dController.appendTo) {\n        this.object3dController.appendTo.remove(this.object3d);\n      } else if (\n        this.parentObjectDirective &&\n        this.object3dController.appendMode === 'immediate'\n      ) {\n        this.parentObjectDirective.object3d.remove(this.object3d);\n      } else {\n        const { scene } = this.canvasStore.getImperativeState();\n        if (scene) {\n          scene.remove(this.object3d);\n        }\n      }\n\n      this.object3d.clear();\n    }\n  }\n}\n"]}